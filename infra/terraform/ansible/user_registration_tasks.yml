
    - name: Get list of secrets from GCP
      ansible.builtin.command: 
        cmd: gcloud secrets list --project={{ project_id }} --format="value(name)"
      register: secret_list
      changed_when: false
      when: not ansible_check_mode

    - name: Fetch password and register user
      ansible.builtin.shell: |
        set -o pipefail
        SECRET_NAME="{{ item }}"
        USERNAME=${SECRET_NAME%-irc-passwd}
        
        # Get password payload
        PASSWORD=$(gcloud secrets versions access latest --secret="$SECRET_NAME" --project="{{ project_id }}")
        
        # Register user via manage-db as the ergo user
        # Using sudo -u instead of become_user to avoid ACL permission issues
        sudo -u ergo /usr/local/bin/ergo manage-db saregister --conf /etc/ergo/ircd.yaml "$USERNAME" "$PASSWORD" "$USERNAME@localhost" || true
      loop: "{{ secret_list.stdout_lines | select('search', '-irc-passwd$') | list }}"
      args:
        executable: /bin/bash
      become: true
      register: user_registration_result
      changed_when: "'successfully created account' in user_registration_result.stdout"
      ignore_errors: true
      when: not ansible_check_mode
