name: Infra CI/CD

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - 'infra/terraform/ansible/**'
      - '.github/workflows/infra.yml'
  push:
    branches: [main]
    paths:
      - 'infra/terraform/**'
      - 'infra/terraform/ansible/**'
      - '.github/workflows/infra.yml'

permissions:
  contents: read

jobs:
  plan_and_dry_run:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: analyze-this-2026
    env:
      TF_IN_AUTOMATION: 'true'
      TF_INPUT: 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2


      - name: Install Ansible
        run: python -m pip install --upgrade pip ansible

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: infra/terraform
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="ssh_source_ranges=[\"${{ secrets.SSH_SOURCE_CIDR }}\"]"

      - name: Ansible Dry Run
        working-directory: infra/terraform/ansible
        run: |
          printf "[irc]\nlocalhost ansible_connection=local\n" > inventory.ci.ini
          ansible-playbook playbook.yml \
            -i inventory.ci.ini \
            --check \
            -e project_id=${{ secrets.GCP_PROJECT_ID }} \
            -e server_name=chat.interestedparticipant.org \
            -e irc_port_internal=6667

  apply_and_configure:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: analyze-this-2026
    env:
      TF_IN_AUTOMATION: 'true'
      TF_INPUT: 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2


      - name: Install Ansible
        run: python -m pip install --upgrade pip ansible

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: infra/terraform
        run: |
          terraform apply -auto-approve \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="ssh_source_ranges=[\"${{ secrets.SSH_SOURCE_CIDR }}\"]"

      - name: Generate Ansible Inventory
        run: |
          echo "[irc]" > infra/terraform/ansible/inventory.ini
          gcloud compute instances list \
            --filter="tags.items=irc-backend AND status:RUNNING" \
            --format="value(networkInterfaces[0].accessConfigs[0].natIP)" \
            | while read ip; do
              echo "$ip ansible_user=debian" >> infra/terraform/ansible/inventory.ini
            done
          cat infra/terraform/ansible/inventory.ini


      - name: Write SSH key
        working-directory: infra/terraform/ansible
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Ansible Apply
        working-directory: infra/terraform/ansible
        env:
          ANSIBLE_PRIVATE_KEY_FILE: ~/.ssh/id_rsa
        run: |
          ansible-playbook playbook.yml \
            -i inventory.ini \
            -e project_id=${{ secrets.GCP_PROJECT_ID }} \
            -e server_name=chat.interestedparticipant.org \
            -e irc_port_internal=6667
