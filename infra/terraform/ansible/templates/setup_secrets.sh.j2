#!/bin/bash
set -euo pipefail

SECRETS_DIR="/etc/secrets"
mkdir -p "$SECRETS_DIR"
chmod 700 "$SECRETS_DIR"

PROJECT_ID="{{ project_id }}"

# Fetch secrets
# irc-server-password -> server_password
if ! gcloud secrets versions access latest --secret="{{ secret_server_password }}" --project="$PROJECT_ID" > "$SECRETS_DIR/server_password"; then
    echo "Failed to fetch server_password"
    exit 1
fi

# irc-oper-password -> oper_password
if ! gcloud secrets versions access latest --secret="{{ secret_oper_password }}" --project="$PROJECT_ID" > "$SECRETS_DIR/oper_password"; then
    echo "Failed to fetch oper_password"
    exit 1
fi

# ergo-webirc-password -> webirc_password
if ! gcloud secrets versions access latest --secret="ergo-webirc-password" --project="$PROJECT_ID" > "$SECRETS_DIR/webirc_password"; then
    echo "Failed to fetch webirc_password"
    exit 1
fi

# irccat-irc-passwd -> irccat_password
if ! gcloud secrets versions access latest --secret="irccat-irc-passwd" --project="$PROJECT_ID" > "$SECRETS_DIR/irccat_password"; then
    echo "Failed to fetch irccat_password"
    exit 1
fi

# ergo-mysql-password -> mysql_password
if ! gcloud secrets versions access latest --secret="{{ secret_mysql_password }}" --project="$PROJECT_ID" > "$SECRETS_DIR/mysql_password"; then
    echo "Failed to fetch mysql_password"
    exit 1
fi

# Generate Hashes for Ergo
/usr/local/bin/ergo genpasswd < "$SECRETS_DIR/server_password" > "$SECRETS_DIR/server_password.hash"
/usr/local/bin/ergo genpasswd < "$SECRETS_DIR/oper_password" > "$SECRETS_DIR/oper_password.hash"
/usr/local/bin/ergo genpasswd < "$SECRETS_DIR/webirc_password" > "$SECRETS_DIR/webirc_password.hash"

# Export variables for python script
export SERVER_HASH=$(cat "$SECRETS_DIR/server_password.hash")
export OPER_HASH=$(cat "$SECRETS_DIR/oper_password.hash")
export WEBIRC_HASH=$(cat "$SECRETS_DIR/webirc_password.hash")

export SERVER_PASS=$(cat "$SECRETS_DIR/server_password")
export IRCCAT_PASS=$(cat "$SECRETS_DIR/irccat_password")
export WEBIRC_PASS=$(cat "$SECRETS_DIR/webirc_password")
export MYSQL_PASS=$(cat "$SECRETS_DIR/mysql_password")

# Python script to perform safe replacement
python3 -c '
import os

def replace_and_write(src, dest, replacements, owner_uid, owner_gid):
    if not os.path.exists(src):
        return
    with open(src, "r") as f:
        content = f.read()
    
    for key, value in replacements.items():
        content = content.replace(key, value)
    
    with open(dest, "w") as f:
        f.write(content)
    
    os.chown(dest, owner_uid, owner_gid)
    os.chmod(dest, 0o640)

# Get UIDs/GIDs
import pwd, grp
try:
    ergo_uid = pwd.getpwnam("ergo").pw_uid
    ergo_gid = grp.getgrnam("ergo").gr_gid
    irccat_uid = pwd.getpwnam("irccat").pw_uid
    irccat_gid = grp.getgrnam("irccat").gr_gid
    thelounge_uid = pwd.getpwnam("thelounge").pw_uid
    thelounge_gid = grp.getgrnam("thelounge").gr_gid
except KeyError:
    # Users might not exist yet if running early, but this script runs after users are created by ansible
    print("Warning: One or more users not found")
    ergo_uid = 0
    ergo_gid = 0
    irccat_uid = 0
    irccat_gid = 0
    thelounge_uid = 0
    thelounge_gid = 0

# Ergo
replace_and_write(
    "/etc/ergo/ircd.yaml.template",
    "/etc/ergo/ircd.yaml",
    {
        "__SERVER_PASSWORD_HASH__": os.environ["SERVER_HASH"],
        "__OPER_PASSWORD_HASH__": os.environ["OPER_HASH"],
        "__WEBIRC_PASSWORD_HASH__": os.environ["WEBIRC_HASH"],
        "__MYSQL_PASSWORD__": os.environ["MYSQL_PASS"],
    },
    ergo_uid, ergo_gid
)

# IRCCat
replace_and_write(
    "/etc/irccat/irccat.json.template",
    "/etc/irccat/irccat.json",
    {
        "__SERVER_PASSWORD__": os.environ["SERVER_PASS"],
        "__IRCCAT_PASSWORD__": os.environ["IRCCAT_PASS"],
    },
    irccat_uid, irccat_gid
)

# The Lounge
replace_and_write(
    "/var/lib/thelounge/config.js.template",
    "/var/lib/thelounge/config.js",
    {
        "__WEBIRC_PASSWORD__": os.environ["WEBIRC_PASS"],
    },
    thelounge_uid, thelounge_gid
)
'

echo "Secrets setup completed and configs generated."
